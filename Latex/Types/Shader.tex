\section{BPX Type: Shader Package ('S')}

\subsection{Overview}
The Shader Package BPX uses 'S' as the type byte of BPX Main Header. This type provides optimized and cross API/platform storage for rendering code intended to be executed on the GPU \cite{GPU}.
\newline
Below is a table describing the different sections to be expected in a BPXS:
\bpxsectiontable
{
    Shader & 1 & Yes & No \\
    SymbolTable & 2 & Yes & Yes \\
    ExtendedData & 3 & No & Yes \\
    Strings & 255 & Yes & Yes \\
}
At least one symbol table section is required to be saved in the file.

\subsubsection{Design decisions}
Due to software/hardware restrictions for some rendering platforms, each rendering platform will require a different BPX Shader Package. For example a Mac is required to build MSL shaders and Windows is required in order to build HLSL shaders.\newline
Use a GL target for best compatibility across all 3 major platforms. For highest performance and compatibility, use a VK target.\newline
The Shader Package exists in two variants: "A" and "P".\newline
The "A" variant or Assembly is used to store common symbols used by a group of shaders. At least one Assembly must be common to all shaders in a given game. This Shader Assembly is known as the main assembly which is guarenteed to contain common symbols such as the material constant buffer, the model matrix constant, etc.\newline
The "P" variant or Program is used to store an entire pipeline including its compiled shaders for a target rendering platform.

\subsection{TypeExt}
Contains information about the shader package.
\bpxfieldtable
{
	Assembly & Unsigned & 64 & Hash of shader assembly \\
	NumSymbols & Unsigned & 16 & Number of symbols \\
	Target & Unsigned & 8 & Target rendering platform \\
	Type & Unsigned & 8 & Type of Shader Package \\
	Reserved & Unspecified & 32 & Blank, always 0 \\
}
\begin{center}
    \begin{bytefield}[bitwidth=1.2em]{32}
        \bitheader{0-31} \\
        \begin{rightwordgroup}{128 bits}
            \bitbox{32}{Assembly} \\
			\bitbox{32}{Assembly} \\
            \bitbox{16}{NumSymbols} & \bitbox{8}{Target} & \bitbox{8}{Type} \\
            \bitbox{32}{Reserved}
        \end{rightwordgroup}
    \end{bytefield}
\end{center}

\subsubsection{Assembly}
The hash of the shader assembly name that this shader package is linked against. In the case this shader package is not (yet) linked against a shader assembly, \textbf{a value of 0 should be written}.

\subsubsection{NumSymbols}
Number of symbols in the symbol table.

\subsubsection{Target}
The target rendering platform that this package supports. The table below lists all supported rendering platforms:
\bpxtable{c|c|C}{Name & Value & Notes}
{
    DX11 & 0x1 & Built for DirectX 11 \cite{DirectX} \\
    DX12 & 0x2 & Built for DirectX 12 \cite{DirectX} \\
    GL33 & 0x3 & Built for OpenGL 3.3+ \cite{OpenGL} \\
    GL40 & 0x4 & Built for OpenGL 4.0+ \cite{OpenGL} \\
    GL41 & 0x5 & Built for OpenGL 4.1+ \cite{OpenGL} \\
    GL42 & 0x6 & Built for OpenGL 4.2+ \cite{OpenGL} \\
    GL43 & 0x7 & Built for OpenGL 4.3+ \cite{OpenGL} \\
    GL44 & 0x8 & Built for OpenGL 4.4+ \cite{OpenGL} \\
    GL45 & 0x9 & Built for OpenGL 4.5+ \cite{OpenGL} \\
    GL46 & 0xA & Built for OpenGL 4.6+ \cite{OpenGL} \\
    ES30 & 0xB & Built for OpenGL ES 3.0+ \cite{OpenGL_ES} \\
    ES31 & 0xC & Built for OpenGL ES 3.1+ \cite{OpenGL_ES} \\
    ES32 & 0xD & Built for OpenGL ES 3.2+ \cite{OpenGL_ES} \\
    VK10 & 0xE & Built for Vulkan 1.0+ \cite{Vulkan} \\
    VK11 & 0xF & Built for Vulkan 1.1+ \cite{Vulkan} \\
    VK12 & 0x10 & Built for Vulkan 1.2+ \cite{Vulkan} \\
    MT & 0x11 & Built for Metal API \cite{Metal} \\
    Any & 0xFF & Works on any rendering platform (designed to be used by a Shader Assembly) \\
}

\subsubsection{Type}
The type of package is either "A" for a Shader Assembly or "P" for a Shader Program / Pipeline.

\subsection{Shader}
Contains shader data for a single stage. The first byte in this section corresponds to the stage the shader is for.\newline
The table below describes all possible values of the stage byte:
\bpxtable{c|c}{Name & Value}
{
	Vertex & 0 \\
	Hull & 1 \\
	Domain & 2 \\
	Geometry & 3 \\
	Pixel & 4 \\
}

\subsection{SymbolTable}
The symbol table section stores information about what symbols are used in this shader program.\newline
This section stores an array of symbol structures. A symbol structure is defined by:
\bpxfieldtable
{
	Name & Unsigned & 32 & Name of symbol \\
    ExtendedData & Unspecified & 32 & Data extension \\
    Flags & Unsigned & 16 & Flags \\
    Type & Unsigned & 8 & Type of symbol \\
    Register & Unsigned & 8 & Register number \\
}
\begin{center}
    \begin{bytefield}[bitwidth=1.4em]{32}
        \bitheader{0-31} \\
        \bitbox{32}{Name} \\
        \bitbox{32}{ExtendedData} \\
        \bitbox{16}{Flags} & \bitbox{8}{Type} & \bitbox{8}{Register}
    \end{bytefield}
\end{center}

\subsubsection{Name}
The name of the symbol as an offset in the string section.

\subsubsection{ExtendedData}
An offset in the ExtendedData section to load a BPXSD object storing additional information about the symbol.\newline
\textbf{The BPXSD object structure is implementation defined.}\newline
\textbf{The value of this field is undefined if the flag ExtendedData is not set.}

\subsubsection{Flags}
Describes what this symbol is used for. Use bit-or operation to combine multiple flags together. Below is a table to list the different available flags:
\bpxtable{c|c|C}{Name & Value & Notes}
{
    VertexStage & 0x1 & Indicates the symbol applies to the vertex stage \\
    HullStage & 0x2 & Indicates the symbol applies to the hull stage \\
    DomainStage & 0x4 & Indicates the symbol applies to the domain stage \\
    GeometryStage & 0x8 & Indicates the symbol applies to the geometry stage \\
    PixelStage & 0x10 & Indicates the symbol applies to the pixel stage \\
    Assembly & 0x20 & Indicates the symbol is part of a Shader Assembly \\
    External & 0x40 & Indicates the symbol is not defined by this package \\
    Internal & 0x80 & Indicates the symbol is defined by this package \\
    ExtendedData & 0x100 & Indicates the symbol has extended data \\
    Register & 0x200 & Indicates the symbol consumes a register/slot number in the pipeline \\
}

\subsubsection{Type}
The type of symbol. Currently there are only 6 types of symbols:
\bpxtable{c|c|C}{Name & Value & Notes}
{
    Texture & 0 & A texture symbol \\
    Sampler & 1 & A sampler symbol \\
    ConstantBuffer & 2 & A constant buffer symbol \\
    Constant & 3 & A high-performance constant \\
    VertexFormat & 4 & A vertex format. \textbf{Only one vertex format is allowed per shader program} \\
    Pipeline & 5 & A pipeline definition. \textbf{Only one pipeline is allowed per shader program} \\
    Output & 6 & A render target output definition. \\
}

\subsubsection{Register}
The register or slot number this symbol should be bound to.\newline
\textbf{The value of this field is undefined if the flag Register is not set.}

\subsection{ExtendedData}
Contains all BPXSD extension objects for all symbols that need additional information.\newline
Refer to \ref{ssec:Structured} for more information about BPXSD encoding/decoding.

\subsection{Strings}
The strings section contains a list of null-terminated strings to be referenced by start offset from other sections (see \ref{ssec:Strings}).